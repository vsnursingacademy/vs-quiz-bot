import { useEffect, useState } from 'react';
import { useRouter } from 'next/router';
import { supabaseClient } from '@/lib/supabaseClient';
import Papa from 'papaparse';
export default function Questions(){const router=useRouter();const {id}=router.query;const [questions,setQuestions]=useState([]);const [text,setText]=useState('');const [position,setPosition]=useState(1);const [explanation,setExplanation]=useState('');const [timeLimit,setTimeLimit]=useState('');const [tag,setTag]=useState('');const [lang,setLang]=useState('en');const [busy,setBusy]=useState(false);const [msg,setMsg]=useState('');async function load(){if(!id)return;const {data}=await supabaseClient.from('questions').select('id,text,position,image_path,time_limit_seconds').eq('quiz_id',id).order('position',{ascending:true});setQuestions(data||[]);}useEffect(()=>{load();},[id]);async function addQuestion(e){e.preventDefault();const {data:qRow}=await supabaseClient.from('questions').insert([{quiz_id:id,text,position:Number(position),explanation,time_limit_seconds: timeLimit?Number(timeLimit):null}]).select('id').single();if(qRow&&tag){await supabaseClient.from('question_tags').insert([{question_id:qRow.id,tag:tag.trim()}]);}if(qRow&&lang&&text){await supabaseClient.from('question_i18n').insert([{question_id:qRow.id,lang,text,explanation}]);}setText('');setPosition(questions.length+2);setExplanation('');setTimeLimit('');setTag('');load();}function handleCSV(e){const file=e.target.files?.[0];if(!file)return;setBusy(true);setMsg('Parsing CSVâ€¦');Papa.parse(file,{header:true,skipEmptyLines:true,complete:async(res)=>{try{for(const r of res.data){const pos=Number(r.position)||null;const qText=String(r.question||'').trim();if(!qText)continue;const {data:qRow}=await supabaseClient.from('questions').insert([{quiz_id:id,text:qText,position:pos||questions.length+1,explanation:r.explanation||null,time_limit_seconds: r.time_limit_seconds?Number(r.time_limit_seconds):null}]).select('id').single();const correctIndex=Number(r.correct);const opts=[r.option1,r.option2,r.option3,r.option4].map((t,i)=>({question_id:qRow.id,text:String(t||'').trim(),is_correct:(i+1)===correctIndex})).filter(o=>o.text.length>0);if(opts.length){await supabaseClient.from('options').insert(opts);}if(r.tag){await supabaseClient.from('question_tags').insert([{question_id:qRow.id,tag:String(r.tag).trim()}]);}if(r.lang){await supabaseClient.from('question_i18n').insert([{question_id:qRow.id,lang:String(r.lang).trim(),text:qText,explanation:r.explanation||null}]);}}setMsg('CSV import completed.');await load();}catch(err){console.error(err);setMsg('CSV import failed.');}finally{setBusy(false);}}});}async function uploadImage(q, file){if(!file) return;const filePath=`${q.id}/${file.name}`;const {error}=await supabaseClient.storage.from('questions').upload(filePath,file,{upsert:true});if(!error){await supabaseClient.from('questions').update({image_path:filePath}).eq('id',q.id);load();}}return (<div className="page"><h3>Questions</h3><div className="card"><h4>Add single question</h4><form onSubmit={addQuestion} className="row"><input placeholder="Question text" value={text} onChange={e=>setText(e.target.value)} required/><input type="number" min="1" placeholder="Position" value={position} onChange={e=>setPosition(e.target.value)} required/><input placeholder="Explanation (optional)" value={explanation} onChange={e=>setExplanation(e.target.value)}/><input type="number" min="5" placeholder="Time limit (seconds)" value={timeLimit} onChange={e=>setTimeLimit(e.target.value)}/><input placeholder="Tag (e.g., Psych, MSK)" value={tag} onChange={e=>setTag(e.target.value)}/><select value={lang} onChange={e=>setLang(e.target.value)}><option value="en">EN</option><option value="gu">GU</option><option value="hi">HI</option></select><button type="submit">Add</button></form></div><div className="card"><h4>Bulk import from CSV</h4><p>Headers include (extra optional): <code>position,question,option1,option2,option3,option4,correct,explanation,tag,lang,time_limit_seconds</code></p><input type="file" accept=".csv" onChange={handleCSV} disabled={busy}/>{msg&&<p>{msg}</p>}</div><div style={{marginTop:24}}>{(questions||[]).map(q=>(<div className="card" key={q.id}><div><strong>Q{q.position}.</strong> {q.text}</div>{q.image_path&&<div><img src={supabaseClient.storage.from('questions').getPublicUrl(q.image_path).data.publicUrl} alt="" style={{maxWidth:'100%',borderRadius:8}} /></div>}<div className="row"><label>Upload image:</label><input type="file" accept="image/*" onChange={e=>uploadImage(q,e.target.files?.[0])}/></div></div>))}</div></div>)}
